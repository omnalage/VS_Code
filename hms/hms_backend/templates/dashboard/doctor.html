<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard - HMS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        
        .navbar {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navbar-brand {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .navbar-menu {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .navbar-menu a, .logout-btn {
            color: #666;
            text-decoration: none;
            padding: 8px 15px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
        }
        
        .logout-btn {
            background: #667eea;
            color: white;
            border-radius: 5px;
        }
        
        .logout-btn:hover {
            background: #764ba2;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 15px;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #764ba2;
        }
        
        .btn-secondary {
            background: #ddd;
            color: #333;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .table th {
            background: #f5f5f5;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
        }
        
        .table td {
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .table tr:hover {
            background: #f9f9f9;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-scheduled {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status-completed {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        .success-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-brand">üè• HMS - Doctor Dashboard</div>
        <div class="navbar-menu">
            <a href="#availability">Manage Availability</a>
            <a href="#appointments">My Appointments</a>
            <span id="doctor-name" style="color: #666;"></span>
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>
    </div>
    
    <!-- JS error banner (hidden unless an error occurs) -->
    <div id="js-error-banner" style="display:none; background:#ffe6e6; color:#660000; padding:10px 16px; border-bottom:1px solid #ffcccc; text-align:left; font-size:13px;
                position:relative;">
        <strong>JavaScript error:</strong> <span id="js-error-message"></span>
        <button style="position:absolute; right:8px; top:6px; background:transparent; border:none; font-size:16px; cursor:pointer;" onclick="document.getElementById('js-error-banner').style.display='none'">&times;</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>Welcome, <span id="welcome-name"></span></h1>
            <p>Manage your availability and view your upcoming appointments</p>
        </div>
        
        <!-- Doctor Profile Section -->
        <div class="section-title">üë®‚Äç‚öïÔ∏è My Profile</div>
        <div class="card">
            <div id="profile-info"></div>
        </div>
        
        <!-- Availability Management Section -->
        <div class="section-title" id="availability">‚è∞ Manage Availability</div>
        <div class="card">
            <button class="btn btn-primary" onclick="openAddSlotModal()">+ Add Time Slot</button>
            <table class="table" id="availability-table">
                <thead>
                    <tr>
                        <th>Day</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="availability-body"></tbody>
            </table>
            <div class="empty-state" id="no-slots">
                <div class="empty-state-icon">üì≠</div>
                <p>No availability slots yet. Add your first slot!</p>
            </div>
        </div>
        
        <!-- Appointments Section -->
        <div class="section-title" id="appointments">üìÖ My Appointments</div>
        <div class="card">
            <table class="table" id="appointments-table">
                <thead>
                    <tr>
                        <th>Patient</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Reason</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="appointments-body"></tbody>
            </table>
            <div class="empty-state" id="no-appointments">
                <div class="empty-state-icon">üì≠</div>
                <p>No appointments scheduled yet</p>
            </div>
        </div>
    </div>
    
    <!-- Add Slot Modal -->
    <div class="modal" id="add-slot-modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeAddSlotModal()">&times;</span>
            <h2>Add Availability Slot</h2>
            <div class="success-message" id="slot-success">Slot added successfully!</div>
            <form onsubmit="handleAddSlot(event)">
                <div class="form-group">
                    <label for="slot-day">Day of Week</label>
                    <select id="slot-day" required>
                        <option value="">Select Day</option>
                        <option value="MON">Monday</option>
                        <option value="TUE">Tuesday</option>
                        <option value="WED">Wednesday</option>
                        <option value="THU">Thursday</option>
                        <option value="FRI">Friday</option>
                        <option value="SAT">Saturday</option>
                        <option value="SUN">Sunday</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="slot-start">Start Time</label>
                        <input type="time" id="slot-start" required>
                    </div>
                    <div class="form-group">
                        <label for="slot-end">End Time</label>
                        <input type="time" id="slot-end" required>
                    </div>
                </div>

                    <!-- Medical Reports Modal -->
                    <div class="modal" id="report-modal">
                        <div class="modal-content">
                            <span class="modal-close" onclick="closeReportModal()">&times;</span>
                            <h2>Patient Medical History</h2>
                            <div id="report-patient-name" style="font-weight:600; margin-bottom:6px;"></div>
                            <div id="report-patient-info" style="font-size:13px;color:#666;margin-bottom:10px;"></div>
                            <div id="reports-list" style="max-height: 220px; overflow:auto; margin-bottom:10px; border-top:1px solid #eee; padding-top:10px;"></div>
                            <div id="report-detail" style="padding:10px; border-top:1px solid #f0f0f0; margin-bottom:8px; display:none"></div>
                            <div style="display:flex; gap:10px; justify-content:space-between; align-items:center;">
                                <div id="reports-pagination"></div>
                                <div>
                                    <button class="btn btn-secondary" onclick="openAddReportModal()">Add Report</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add Medical Report Modal -->
                    <div class="modal" id="add-report-modal">
                        <div class="modal-content">
                            <span class="modal-close" onclick="closeAddReportModal()">&times;</span>
                            <h2>Add Medical Report</h2>
                            <div class="success-message" id="report-success">Report saved successfully!</div>
                            <form id="add-report-form" onsubmit="handleAddReport(event)">
                                <input type="hidden" id="report-patient-id">
                                <input type="hidden" id="report-id">
                                <div class="form-group">
                                    <label for="report-summary">Summary</label>
                                    <input id="report-summary" required />
                                </div>
                                <div class="form-group">
                                    <label for="report-details">Details</label>
                                    <textarea id="report-details"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="report-file-input">Attach File (optional)</label>
                                    <input id="report-file-input" type="file" />
                                </div>
                                <button type="submit" class="btn btn-primary" id="report-save-btn">Save Report</button>
                            </form>
                        </div>
                    </div>
                <div style="display:flex; gap:10px; margin-top:8px;">
                    <button type="button" class="btn btn-primary" id="add-slot-save-btn" onclick="handleAddSlot(event, false)" style="flex:1">Add & Close</button>
                    <button type="button" class="btn btn-secondary" onclick="handleAddSlot(event, true)" style="flex:1">Add Another</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Use relative API path so requests are same-origin and cookies are sent
        const API_URL = '/api';
        let currentUser = null;

        // Global JS error handlers to surface runtime issues in the page
        function showJSError(msg) {
            try {
                const banner = document.getElementById('js-error-banner');
                const msgEl = document.getElementById('js-error-message');
                if (msgEl) msgEl.textContent = String(msg);
                if (banner) banner.style.display = 'block';
            } catch (e) {
                console.error('Failed to show JS error banner', e);
            }
        }

        window.addEventListener('error', function (ev) {
            const message = ev && ev.message ? ev.message : String(ev);
            console.error('Unhandled error event:', ev.error || message);
            showJSError(message || 'Unhandled error');
        });

        window.addEventListener('unhandledrejection', function (ev) {
            const reason = ev && ev.reason ? (ev.reason.message || JSON.stringify(ev.reason)) : String(ev);
            console.error('Unhandled promise rejection:', ev.reason || ev);
            showJSError('Promise rejection: ' + reason);
        });

        // Helper to read cookie values (CSRF token)
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        }

        // Sanitize server error responses so we don't inject raw HTML (Django debug pages)
        function sanitizeError(err) {
            if (!err) return '';
            if (typeof err !== 'string') return String(err);
            const stripped = err.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
            if (stripped.length > 0) return stripped;
            return 'Server error';
        }

        // Small wrapper for API requests to centralize CSRF, credentials and error parsing
        async function apiRequest(path, opts = {}) {
            const method = (opts.method || 'GET').toUpperCase();
            const headers = Object.assign({}, opts.headers || {});
            if (opts.json !== false && method !== 'GET' && !headers['Content-Type']) {
                headers['Content-Type'] = 'application/json';
            }
            if (!opts.skipCsrf && method !== 'GET') {
                headers['X-CSRFToken'] = getCookie('csrftoken');
            }

            const res = await fetch(`${API_URL}${path}`, {
                method,
                headers,
                credentials: 'include',
                body: opts.body && headers['Content-Type'] === 'application/json' ? JSON.stringify(opts.body) : opts.body
            });

            const ct = res.headers.get('content-type') || '';
            let body = null;
            try {
                if (ct.includes('application/json')) body = await res.json();
                else body = await res.text();
            } catch (e) {
                body = null;
            }

            if (!res.ok) {
                const errMsg = (body && (body.error || JSON.stringify(body))) || body || `HTTP ${res.status}`;
                throw { status: res.status, body: errMsg };
            }

            return body;
        }

        // Cache some selectors for performance
        const elSlotDay = () => document.getElementById('slot-day');
        const elSlotStart = () => document.getElementById('slot-start');
        const elSlotEnd = () => document.getElementById('slot-end');
        const addSlotForm = () => document.querySelector('#add-slot-modal form');
        let editingSlotId = null;
        
        function handleLogout() {
            isAutoLogoutDisabled = true;
            if (autoLogoutTimer) clearTimeout(autoLogoutTimer);
            console.log('[AUTO-LOGOUT] Manual logout triggered. Clearing timer.');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        // Auto-logout after inactivity (10 minutes)
        let autoLogoutTimer = null;
        const AUTO_LOGOUT_MS = 10 * 60 * 1000; // 10 minutes
        let autoLogoutStartTime = null;
        let isAutoLogoutDisabled = false;

        function handleAutoLogout() {
            console.warn('[AUTO-LOGOUT] Inactivity timeout triggered');
            // attempt server logout then redirect
            (async () => {
                try {
                    await apiRequest('/auth/logout/', { method: 'POST' });
                } catch (e) {
                    console.warn('[AUTO-LOGOUT] Server logout failed:', e);
                }
                alert('You have been logged out due to inactivity');
                window.location.href = '/';
            })();
        }

        function startAutoLogoutTimer() {
            if (isAutoLogoutDisabled) return;
            if (autoLogoutTimer) clearTimeout(autoLogoutTimer);
            autoLogoutStartTime = Date.now();
            autoLogoutTimer = setTimeout(handleAutoLogout, AUTO_LOGOUT_MS);
            const nextLogoutMin = (AUTO_LOGOUT_MS / 60000).toFixed(0);
            console.log(`[AUTO-LOGOUT] Timer started. Will logout in ${nextLogoutMin} minutes at ${new Date(Date.now() + AUTO_LOGOUT_MS).toLocaleTimeString()}`);
        }

        function resetAutoLogoutTimer() {
            if (isAutoLogoutDisabled) return;
            const elapsed = autoLogoutStartTime ? ((Date.now() - autoLogoutStartTime) / 60000).toFixed(1) : '?';
            console.log(`[AUTO-LOGOUT] Activity detected (${elapsed} min elapsed). Resetting timer...`);
            startAutoLogoutTimer();
        }

        // Reset timer on common user interactions
        ['click', 'mousemove', 'keydown', 'scroll', 'touchstart'].forEach(evt => {
            window.addEventListener(evt, resetAutoLogoutTimer, { passive: true });
        });
        
        async function initializeDashboard() {
            try {
                const data = await apiRequest('/auth/current_user/');
                currentUser = data;

                document.getElementById('welcome-name').textContent = currentUser.user.first_name || currentUser.user.username;
                document.getElementById('doctor-name').textContent = currentUser.user.first_name || currentUser.user.username;

                loadDoctorProfile();
                loadAvailabilitySlots();
                loadAppointments();
                // start inactivity auto-logout timer
                console.log('[AUTO-LOGOUT] Dashboard initialized. Starting auto-logout timer...');
                startAutoLogoutTimer();
            } catch (error) {
                console.error('Failed to initialize dashboard:', error);
                window.location.href = '/';
            }
        }
        
        async function loadDoctorProfile() {
            try {
                const doctor = await apiRequest('/doctors/my_profile/');
                const profileHtml = `
                    <p><strong>Specialization:</strong> ${doctor.specialization}</p>
                    <p><strong>License Number:</strong> ${doctor.license_number}</p>
                    <p><strong>Experience:</strong> ${doctor.experience_years} years</p>
                    <p><strong>Consultation Fee:</strong> ‚Çπ${doctor.consultation_fee}</p>
                    <p><strong>Status:</strong> ${doctor.is_available ? 'Available' : 'Not Available'}</p>
                `;
                document.getElementById('profile-info').innerHTML = profileHtml;
            } catch (error) {
                console.error('Failed to load doctor profile:', error);
            }
        }
        
        async function loadAvailabilitySlots() {
            try {
                const slots = await apiRequest('/doctors/availability/');
                const tbody = document.getElementById('availability-body');
                const noSlots = document.getElementById('no-slots');

                if (slots.length === 0) {
                    tbody.innerHTML = '';
                    noSlots.style.display = 'block';
                    document.getElementById('availability-table').style.display = 'none';
                } else {
                    noSlots.style.display = 'none';
                    document.getElementById('availability-table').style.display = 'table';
                    tbody.innerHTML = slots.map(slot => `
                        <tr>
                            <td>${slot.day_of_week}</td>
                            <td>${slot.start_time}</td>
                            <td>${slot.end_time}</td>
                            <td><span class="status-badge ${slot.is_active ? 'status-scheduled' : 'status-cancelled'}">${slot.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <button class="btn btn-secondary" onclick="editSlot(${slot.id})">Edit</button>
                                <button class="btn btn-danger" onclick="deleteSlot(${slot.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load availability slots:', error);
            }
        }
        
        async function loadAppointments() {
            try {
                const appointments = await apiRequest('/appointments/');
                const tbody = document.getElementById('appointments-body');
                const noAppointments = document.getElementById('no-appointments');

                if (appointments.length === 0) {
                    tbody.innerHTML = '';
                    noAppointments.style.display = 'block';
                    document.getElementById('appointments-table').style.display = 'none';
                } else {
                    noAppointments.style.display = 'none';
                    document.getElementById('appointments-table').style.display = 'table';
                    tbody.innerHTML = appointments.map(apt => `
                        <tr>
                            <td><a href="#" onclick="viewAppointment(${apt.id});return false;">${apt.patient_name}</a></td>
                            <td>${apt.appointment_date}</td>
                            <td>${apt.start_time}</td>
                            <td>${apt.reason || '-'}</td>
                            <td><span class="status-badge status-${apt.status}">${apt.status.toUpperCase()}</span></td>
                            <td>
                                <button class="btn btn-secondary" onclick="viewAppointment(${apt.id})">View</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load appointments:', error);
            }
        }
        
        function openAddSlotModal() {
            document.getElementById('add-slot-modal').classList.add('active');
        }
        
        function closeAddSlotModal() {
            document.getElementById('add-slot-modal').classList.remove('active');
            document.getElementById('slot-success').classList.remove('show');
        }
        
        async function handleAddSlot(event, keepOpen = false) {
            if (event && typeof event.preventDefault === 'function') event.preventDefault();

            const data = {
                day_of_week: elSlotDay().value,
                start_time: elSlotStart().value,
                end_time: elSlotEnd().value,
                is_active: true
            };

            try {
                // If editingSlotId is set, perform update
                if (editingSlotId) {
                    await apiRequest(`/doctors/availability/${editingSlotId}/`, { method: 'PUT', body: data });
                    document.getElementById('slot-success').textContent = 'Slot updated successfully!';
                } else {
                    await apiRequest('/doctors/availability/', { method: 'POST', body: data });
                    document.getElementById('slot-success').textContent = 'Slot added successfully!';
                }

                document.getElementById('slot-success').classList.add('show');
                // refresh list so user sees the newly added slot
                await loadAvailabilitySlots();

                if (keepOpen) {
                    // clear inputs so user can add another slot quickly
                    elSlotDay().value = '';
                    elSlotStart().value = '';
                    elSlotEnd().value = '';
                    editingSlotId = null;
                    // keep modal open and update button text
                    document.getElementById('add-slot-modal').classList.add('active');
                    document.getElementById('add-slot-save-btn').textContent = 'Add & Close';
                    // keep the success message for a short moment
                    setTimeout(() => {
                        document.getElementById('slot-success').classList.remove('show');
                    }, 1000);
                } else {
                    // close modal after brief confirmation
                    setTimeout(() => {
                        closeAddSlotModal();
                        loadAvailabilitySlots();
                    }, 800);
                }
            } catch (error) {
                console.error('Failed to add/update slot:', error);
                const message = sanitizeError(error.body) || `Failed to save slot (status ${error.status || 'error'})`;
                alert(message);
            } finally {
                editingSlotId = null;
            }
        }
        
        async function deleteSlot(slotId) {
            if (confirm('Are you sure you want to delete this slot?')) {
                try {
                    await apiRequest(`/doctors/availability/${slotId}/`, { method: 'DELETE' });
                    loadAvailabilitySlots();
                } catch (error) {
                    console.error('Failed to delete slot:', error);
                    alert(sanitizeError(error.body) || `Failed to delete slot (status ${error.status})`);
                }
            }
        }

        // Edit a slot by opening the Add Slot modal pre-filled
        async function editSlot(slotId) {
            try {
                const slot = await apiRequest(`/doctors/availability/${slotId}/`);
                editingSlotId = slotId;
                elSlotDay().value = slot.day_of_week || '';
                elSlotStart().value = slot.start_time || '';
                elSlotEnd().value = slot.end_time || '';
                document.querySelector('#add-slot-modal .btn-primary').textContent = 'Save Changes';
                document.getElementById('add-slot-modal').classList.add('active');
            } catch (error) {
                console.error('Failed to fetch slot for edit:', error);
                alert(sanitizeError(error.body) || 'Failed to load slot');
            }
        }

        // View appointment details quickly and open reports modal
        let currentReportPatientId = null;
        let currentReportPatientName = '';
        let currentReports = [];
        const REPORTS_PER_PAGE = 6;

        async function viewAppointment(appointmentId) {
            console.log('viewAppointment called for id=', appointmentId);
            // Open modal early so user gets immediate feedback
            openReportModal();
            try {
                const apt = await apiRequest(`/appointments/${appointmentId}/`);
                currentReportPatientId = apt.patient;
                currentReportPatientName = apt.patient_name || apt.patient;
                document.getElementById('report-patient-name').textContent = currentReportPatientName;

                // Fetch patient profile (if allowed) and show patient details (non-blocking)
                (async () => {
                    try {
                        const profile = await apiRequest(`/users/${currentReportPatientId}/`);
                        const p = profile || {};
                        const user = p.user || {};
                        const info = [];
                        if (user.email) info.push(`<strong>Email:</strong> ${user.email}`);
                        if (p.phone_number) info.push(`<strong>Phone:</strong> ${p.phone_number}`);
                        if (p.role) info.push(`<strong>Role:</strong> ${p.role}`);
                        if (p.created_at) info.push(`<strong>Member since:</strong> ${new Date(p.created_at).toLocaleDateString()}`);
                        document.getElementById('report-patient-info').innerHTML = info.join(' &nbsp; | &nbsp; ');
                    } catch (e) {
                        console.warn('Could not fetch patient profile:', e);
                        document.getElementById('report-patient-info').innerHTML = '';
                    }
                })();

                // Load reports for this patient (show errors inside modal)
                try {
                    await loadReports(currentReportPatientId);
                } catch (e) {
                    console.error('Error loading reports after appointment view:', e);
                    document.getElementById('reports-list').innerHTML = `<p style="color:#c00">${sanitizeError(e.body) || 'Failed to load reports'}</p>`;
                }

            } catch (error) {
                console.error('Failed to load appointment:', error);
                // show error inside modal rather than silent failure
                document.getElementById('reports-list').innerHTML = `<p style="color:#c00">${sanitizeError(error.body) || 'Failed to load appointment'}</p>`;
            }
        }

        function openReportModal() {
            document.getElementById('report-patient-name').textContent = currentReportPatientName;
            document.getElementById('report-modal').classList.add('active');
            document.getElementById('reports-list').innerHTML = '<p style="color:#666">Loading reports...</p>';
            document.getElementById('reports-pagination').innerHTML = '';
        }

        function closeReportModal() {
            document.getElementById('report-modal').classList.remove('active');
            // clear details area
            document.getElementById('reports-list').innerHTML = '';
            currentReports = [];
        }

        async function loadReports(patientId) {
            try {
                const reports = await apiRequest(`/medical_reports/?patient_id=${patientId}`);
                currentReports = reports || [];
                renderReports(1);
            } catch (error) {
                console.error('Failed to load reports:', error);
                document.getElementById('reports-list').innerHTML = `<p style="color:#c00">${sanitizeError(error.body) || 'Failed to load reports'}</p>`;
            }
        }

        function renderReports(page) {
            const listEl = document.getElementById('reports-list');
            const paginationEl = document.getElementById('reports-pagination');
            if (!currentReports || currentReports.length === 0) {
                listEl.innerHTML = '<p style="color:#666">No medical reports found for this patient.</p>';
                paginationEl.innerHTML = '';
                return;
            }

            const total = currentReports.length;
            const pages = Math.max(1, Math.ceil(total / REPORTS_PER_PAGE));
            const p = Math.min(Math.max(1, page), pages);
            const start = (p - 1) * REPORTS_PER_PAGE;
            const slice = currentReports.slice(start, start + REPORTS_PER_PAGE);

            listEl.innerHTML = slice.map(r => `
                <div style="border-bottom:1px solid #eee; padding:8px 0;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:600">${r.summary || '(no summary)'}</div>
                            <div style="font-size:12px; color:#666">${r.report_date || r.created_at || ''} ‚Äî by ${r.doctor_name || '-'}</div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-secondary" onclick="showReportDetails(${r.id})">View</button>
                            ${ (typeof currentUser !== 'undefined' && (currentUser.role === 'nurse' || (currentUser.user && currentUser.user.id === r.doctor_user))) ? `<button class="btn btn-secondary" onclick="openEditReport(${r.id})">Edit</button>` : '' }
                        </div>
                    </div>
                </div>
            `).join('');

            // pagination
            let pagHtml = '';
            if (pages > 1) {
                if (p > 1) pagHtml += `<button class="btn btn-secondary" onclick="renderReports(${p - 1})">Prev</button>`;
                pagHtml += ` <span style="margin:0 8px; color:#666">Page ${p} of ${pages}</span>`;
                if (p < pages) pagHtml += `<button class="btn btn-secondary" onclick="renderReports(${p + 1})">Next</button>`;
            }
            paginationEl.innerHTML = pagHtml;
        }

        async function showReportDetails(reportId) {
            try {
                const r = await apiRequest(`/medical_reports/${reportId}/`);
                const detailEl = document.getElementById('report-detail');
                const fileLink = r.file ? `<div><a href="${r.file}" target="_blank">Download attached file</a></div>` : '';
                detailEl.innerHTML = `
                    <div style="font-weight:700; margin-bottom:6px">${r.summary || '(no summary)'}</div>
                    <div style="font-size:12px; color:#666; margin-bottom:8px">${r.report_date || r.created_at} ‚Äî by ${r.doctor_name || '-'}</div>
                    <div style="white-space:pre-wrap; margin-bottom:8px">${r.details || '(no details)'}</div>
                    ${fileLink}
                `;
                detailEl.style.display = 'block';
            } catch (error) {
                console.error('Failed to load report details:', error);
                alert(sanitizeError(error.body) || 'Failed to load report');
            }
        }

        async function openEditReport(reportId) {
            try {
                const r = await apiRequest(`/medical_reports/${reportId}/`);
                document.getElementById('report-id').value = r.id;
                document.getElementById('report-patient-id').value = r.patient || currentReportPatientId || '';
                document.getElementById('report-summary').value = r.summary || '';
                document.getElementById('report-details').value = r.details || '';
                // Note: file inputs cannot be set programmatically for security; user may attach new file to replace
                document.getElementById('report-save-btn').textContent = 'Update Report';
                document.getElementById('report-success').classList.remove('show');
                document.getElementById('add-report-modal').classList.add('active');
            } catch (error) {
                console.error('Failed to load report for editing:', error);
                alert(sanitizeError(error.body) || 'Failed to load report for editing');
            }
        }

        function openAddReportModal(patientId) {
            if (patientId) currentReportPatientId = patientId;
            document.getElementById('report-patient-id').value = currentReportPatientId || '';
            document.getElementById('report-id').value = '';
            document.getElementById('report-summary').value = '';
            document.getElementById('report-details').value = '';
            const fileInput = document.getElementById('report-file-input');
            if (fileInput) fileInput.value = null;
            document.getElementById('report-success').classList.remove('show');
            document.getElementById('report-save-btn').textContent = 'Save Report';
            document.getElementById('add-report-modal').classList.add('active');
        }

        function closeAddReportModal() {
            document.getElementById('add-report-modal').classList.remove('active');
            document.getElementById('report-success').classList.remove('show');
        }

        async function handleAddReport(event) {
            event.preventDefault();
            const patientVal = document.getElementById('report-patient-id').value || currentReportPatientId;
            const editingId = (document.getElementById('report-id') && document.getElementById('report-id').value) || '';
            if (!patientVal) {
                alert('No patient selected');
                return;
            }

            const fileInput = document.getElementById('report-file-input');
            // If a file is attached, use FormData so file uploads work
            let useForm = false;
            if (fileInput && fileInput.files && fileInput.files.length > 0) useForm = true;

            try {
                if (useForm) {
                    const fd = new FormData();
                    fd.append('patient', parseInt(patientVal, 10));
                    fd.append('summary', document.getElementById('report-summary').value);
                    fd.append('details', document.getElementById('report-details').value);
                    fd.append('file', fileInput.files[0]);
                    if (editingId) {
                        await apiRequest(`/medical_reports/${editingId}/`, { method: 'PUT', body: fd, json: false });
                    } else {
                        await apiRequest('/medical_reports/', { method: 'POST', body: fd, json: false });
                    }
                } else {
                    const payload = {
                        patient: parseInt(patientVal, 10),
                        summary: document.getElementById('report-summary').value,
                        details: document.getElementById('report-details').value
                    };
                    if (editingId) {
                        await apiRequest(`/medical_reports/${editingId}/`, { method: 'PUT', body: payload });
                    } else {
                        await apiRequest('/medical_reports/', { method: 'POST', body: payload });
                    }
                }
                document.getElementById('report-success').classList.add('show');
                // reload reports
                await loadReports(currentReportPatientId);
                setTimeout(() => {
                    closeAddReportModal();
                }, 1000);
            } catch (error) {
                console.error('Failed to save report:', error);
                alert(sanitizeError(error.body) || `Failed to save report (status ${error.status})`);
            }
        }
        
        // Initialize on page load
        initializeDashboard();
    </script>
</body>
</html>
